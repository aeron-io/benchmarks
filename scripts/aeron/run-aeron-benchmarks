#!/usr/bin/env bash
##
## Copyright 2015-2021 Real Logic Limited.
##
## Licensed under the Apache License, Version 2.0 (the "License");
## you may not use this file except in compliance with the License.
## You may obtain a copy of the License at
##
## https://www.apache.org/licenses/LICENSE-2.0
##
## Unless required by applicable law or agreed to in writing, software
## distributed under the License is distributed on an "AS IS" BASIS,
## WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
## See the License for the specific language governing permissions and
## limitations under the License.
##

AERON_MD=/home/test/dev/aeron/cppbuild/Release/binaries/aeronmd

function pin_all_threads()
{
  echo "taskset -p -a -c $2 $1"
}

function pin_thread()
{
  echo "taskset -p -c $2 $1"
}

function get_thread_id()
{
  local pid=$1
  local thread_name=$2
  echo "\$(ps Ho tid,fname -p $pid | grep \"$thread_name\" | awk '{print \$1}')"
}

function build_command()
{
  local executable=$1
  local other_cores=$2

  local command=""
  command+="$executable& "
  command+="command_pid=\$!; "

  command+="$(pin_all_threads \$command_pid "$other_cores"); "

  shift
  shift
  local count=0
  while [[ $# -gt 0 ]]
  do
    count=$((count + 1))
    local thread_name=$1
    local core=$2
    local thread_id="$(get_thread_id \$command_pid "$thread_name")"
    command+="thread_$count=$thread_id; "
    command+="$(pin_thread \$thread_$count "$core"); "
    shift
    shift
  done

  echo $command
}

function launch_c_driver()
{
  local path_on_remote_node=$1
#  local exec="$path_on_remote_node/scripts/aeron/c-media-driver"
  local exec="$AERON_MD"
  local core0=$2
  local core1=$3
  local core2=$4
  local core3=$5
  echo $(build_command $exec "$core0" "aeronmd" "$core1" "sender" "$core2" "receiver" "$core3")
}

function run_over_ssh()
{
  local command=$1;
  local user=$2;
  local host=$4;
  ssh $user@$host "$command"
  #ssh vivek@server1.cyberciti.biz << EOF
  #$command
  #EOF
}

echo $(launch_c_driver "/Users/gezr/projects/oss/aeron-benchmarks" "3-5" "0" "1" "2")
#var=$(pin_all_threads "3440" "6-30:2")
#echo $var
#var=$(pin_thread "3447" "0")
#echo $var