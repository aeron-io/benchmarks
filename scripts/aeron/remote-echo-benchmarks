#!/usr/bin/env bash
##
## Copyright 2015-2021 Real Logic Limited.
##
## Licensed under the Apache License, Version 2.0 (the "License");
## you may not use this file except in compliance with the License.
## You may obtain a copy of the License at
##
## https://www.apache.org/licenses/LICENSE-2.0
##
## Unless required by applicable law or agreed to in writing, software
## distributed under the License is distributed on an "AS IS" BASIS,
## WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
## See the License for the specific language governing permissions and
## limitations under the License.
##

# temp
SSH_USER=test
SSH_HOST_1=192.168.56.101
SSH_HOST_2=192.168.56.102
BENCHMARKS_PATH=/home/test/dev/aeron-benchmarks
HOST_1_JAVA_HOME="/home/test/dev/zulu8.50.0.51-ca-jdk8.0.275-linux_x64"
HOST_2_JAVA_HOME="/home/test/dev/zulu8.50.0.51-ca-jdk8.0.275-linux_x64"
NODE_1_CORE_0="3-5"
NODE_1_CORE_1=0
NODE_1_CORE_2=1
NODE_1_CORE_3=2
NODE_2_CORE_0="3-5"
NODE_2_CORE_1=0
NODE_2_CORE_2=1
NODE_2_CORE_3=2
AERON_DESTINATION_CHANNELS="uk.co.real_logic.benchmarks.aeron.remote.destination.channels=aeron:udp?endpoint=192.168.56.102:13333|interface=192.168.56.0/24"
AERON_SOURCE_CHANNELS="uk.co.real_logic.benchmarks.aeron.remote.source.channels=aeron:udp?endpoint=192.168.56.101:13334|interface=192.168.56.0/24"

ITERATIONS=3
NUMBER_OF_MESSAGES=1000
BURST_SIZE=1
MESSAGE_LENGTH=32
RUNS=2

required_vars=(
"SSH_USER" \
"SSH_HOST_1" \
"SSH_HOST_2" \
"BENCHMARKS_PATH" \
"NODE_1_CORE_0" \
"NODE_1_CORE_2" \
"NODE_1_CORE_3" \
"NODE_2_CORE_0" \
"NODE_2_CORE_2" \
"NODE_2_CORE_3" \
"AERON_DESTINATION_CHANNELS" \
"AERON_SOURCE_CHANNELS" \
)

for var in "${required_vars[@]}"; do
  if [[ -z "${!var}" ]]
  then
    echo "env var $var is required"
    required_var_missing=true
  fi
done

if [ -n "$required_var_missing" ];
then
  exit 1
fi

if [ -z "$RUNS" ];
then
  RUNS=5
fi

if [ -z "$ITERATIONS" ];
then
  ITERATIONS=10
fi

if [ -z "$NUMBER_OF_MESSAGES" ];
then
  NUMBER_OF_MESSAGES=10000
fi

if [ -z "$BURST_SIZE" ];
then
  BURST_SIZE="1,10"
fi

if [ -z "$MESSAGE_LENGTH" ];
then
  MESSAGE_LENGTH="32,224,1378"
fi

function pin_all_threads()
{
  echo "taskset -p -a -c $2 $1"
}

function pin_thread()
{
  echo "taskset -p -c $2 $1"
}

function get_thread_id()
{
  local pid=$1
  local thread_name=$2
  echo "\$(ps Ho tid,comm -p $pid | grep \"$thread_name\" | awk '{print \$1}')"
}

function background_command()
{
  local executable=$1
  local other_cores=$2

  local command=""
  command+="$executable& script_pid=\$! && command_pid=\$script_pid && sleep 1"
  command+="&& pid=\$command_pid; while [ \"\$pid\" ]; do command_pid=\$pid; echo \"command_pid=\$command_pid\"; pid=\$(ps -o pid= --ppid \$pid | sed 's/^ *//;s/ *$//'); done"

  command+=" && $(pin_all_threads \$command_pid "$other_cores")"

  shift
  shift
  while [[ $# -gt 0 ]]
  do
    local thread_name=$1
    local core=$2
    local thread_id="$(get_thread_id \$command_pid "$thread_name")"
    command+=" && tid=$thread_id && $(pin_thread \$tid "$core")"
    shift
    shift
  done

  echo $command
}

function launch_c_driver()
{
  local exec=$1
  local core0=$2
  local core1=$3
  local core2=$4
  local core3=$5
  echo $(background_command "$exec" "$core0" "aeronmd" "$core1" "sender" "$core2" "receiver" "$core3")
}

function run_benchmarks()
{
  local client_command="$1"
  local server_command="$2"
  local config_file="$3"
  local config_options=("${@:4}")

  for messages in "${NUMBER_OF_MESSAGES[@]}"
  do
    for burst in "${BURST_SIZE[@]}"
    do
      for length in "${MESSAGE_LENGTH[@]}"
      do
        for (( i=1; i<=RUNS; i++ ))
        do
          echo -e '\n#######################'
          echo 'Benchmark run #'$i' ...'
          echo '#######################'

          config_options+=("uk.co.real_logic.benchmarks.remote.iterations=${ITERATIONS}")
          config_options+=("uk.co.real_logic.benchmarks.remote.messages=${messages# }")
          config_options+=("uk.co.real_logic.benchmarks.remote.batchSize=${burst# }")
          config_options+=("uk.co.real_logic.benchmarks.remote.messageLength=${length# }")

          local jvm_opts="rm -f $config_file"
          for opt in "${config_options[@]}";
          do
            jvm_opts+=" && echo '$opt' >> $config_file"
          done

          ssh $SSH_USER@$SSH_HOST_2 "$jvm_opts && $server_command" &
          ssh $SSH_USER@$SSH_HOST_1 "$jvm_opts && $client_command"
          wait # wait for the server command to complete
        done
      done
    done
  done
}

function build_drivers()
{
  local commands=()

  # Java driver
  commands+=("$(background_command \
  "$BENCHMARKS_PATH/scripts/aeron/media-driver" "$1" "driver-conducto" "$2" "sender" "$3" "receiver" "$4")")

  # Java driver with Onload
  commands+=("$(background_command \
  "onload --profile=latency --force-profiles $BENCHMARKS_PATH/scripts/aeron/media-driver" \
  "$1" "driver-conductor" "$2" "sender" "$3" "receiver" "$4")")

  # C driver
  commands+=("$(background_command \
  "$BENCHMARKS_PATH/scripts/aeron/c-media-driver" "$1" "aeronmd" "$2" "sender" "$3" "receiver" "$4")")

  # C driver with Onload
  commands+=("$(background_command \
  "onload --profile=latency --force-profiles $BENCHMARKS_PATH/scripts/aeron/c-media-driver" \
  "$1" "aeronmd" "$2" "sender" "$3" "receiver" "$4")")

  # C driver with ef_vi
  commands+=("$(background_command \
  "AERON_UDP_CHANNEL_TRANSPORT_BINDINGS_MEDIA=\"aeron_udp_channel_transport_ef_vi_bindings\" \
  AERON_DRIVER_DYNAMIC_LIBRARIES=\"$BENCHMARKS_PATH/scripts/aeron/libaeron_ef_vi.so\" \
  $BENCHMARKS_PATH/scripts/aeron/c-media-driver" \
  "$1" "aeronmd" "$2" "sender" "$3" "receiver" "$4")")

  # C driver with ATS
  commands+=("$(background_command \
  "AERON_TRANSPORT_SECURITY_CONF_DIR=\"$BENCHMARKS_PATH/scripts/aeron\" \
  AERON_TRANSPORT_SECURITY_CONF_FILE=ats.conf \
  AERON_UDP_CHANNEL_OUTGOING_INTERCEPTORS=\"aeron_transport_security_channel_interceptor_load\" \
  AERON_UDP_CHANNEL_INCOMING_INTERCEPTORS=\"aeron_transport_security_channel_interceptor_load\" \
  AERON_DRIVER_DYNAMIC_LIBRARIES=\"$BENCHMARKS_PATH/scripts/aeron/libaeron_transport_security.so\" \
  $BENCHMARKS_PATH/scripts/aeron/c-media-driver" \
  "$1" "aeronmd" "$2" "sender" "$3" "receiver" "$4")")

  # C driver with ATS and Onload
  commands+=("$(background_command \
  "AERON_TRANSPORT_SECURITY_CONF_DIR=\"$BENCHMARKS_PATH/scripts/aeron\" \
  AERON_TRANSPORT_SECURITY_CONF_FILE=ats.conf \
  AERON_UDP_CHANNEL_OUTGOING_INTERCEPTORS=\"aeron_transport_security_channel_interceptor_load\" \
  AERON_UDP_CHANNEL_INCOMING_INTERCEPTORS=\"aeron_transport_security_channel_interceptor_load\" \
  AERON_DRIVER_DYNAMIC_LIBRARIES=\"$BENCHMARKS_PATH/scripts/aeron/libaeron_transport_security.so\" \
  onload --profile=latency --force-profiles $BENCHMARKS_PATH/scripts/aeron/c-media-driver" \
  "$1" "aeronmd" "$2" "sender" "$3" "receiver" "$4")")

  # C driver with ATS and ef_vi
  commands+=("$(background_command \
  "AERON_TRANSPORT_SECURITY_CONF_DIR=\"$BENCHMARKS_PATH/scripts/aeron\" \
  AERON_TRANSPORT_SECURITY_CONF_FILE=ats.conf \
  AERON_UDP_CHANNEL_OUTGOING_INTERCEPTORS=\"aeron_transport_security_channel_interceptor_load\" \
  AERON_UDP_CHANNEL_INCOMING_INTERCEPTORS=\"aeron_transport_security_channel_interceptor_load\" \
  AERON_DRIVER_DYNAMIC_LIBRARIES=\"$BENCHMARKS_PATH/scripts/aeron/libaeron_transport_security.so\",\"$BENCHMARKS_PATH/scripts/aeron/libaeron_ef_vi.so\" \
  AERON_UDP_CHANNEL_TRANSPORT_BINDINGS_MEDIA=\"aeron_udp_channel_transport_ef_vi_bindings\" \
  $BENCHMARKS_PATH/scripts/aeron/c-media-driver" \
  "$1" "aeronmd" "$2" "sender" "$3" "receiver" "$4")")

  local IFS=$'\n'
  echo "${commands[*]}"
}

IFS=$'\n'
client_drivers=($(build_drivers "$NODE_1_CORE_0" "$NODE_1_CORE_1" "$NODE_1_CORE_2" "$NODE_1_CORE_3"))
server_drivers=($(build_drivers "$NODE_1_CORE_0" "$NODE_1_CORE_1" "$NODE_1_CORE_2" "$NODE_1_CORE_3"))

scenarios=("java" "java-onload" "c" "c-onload" "c-ef_vi" "c-ats" "c-ats-onload" "c-ats-ef_vi")
for index in "${!scenarios[@]}";
do
  scenario="${scenarios[index]}"
  client_driver="${client_drivers[index]}"
  server_driver="${server_drivers[index]}"

  echo scenario
  echo "$client_driver"

  run_benchmarks\
    "export JAVA_HOME=\"$HOST_1_JAVA_HOME\" && $client_driver && $BENCHMARKS_PATH/scripts/aeron/echo-client && kill -9 \$command_pid && wait" \
    "export JAVA_HOME=\"$HOST_2_JAVA_HOME\" && $server_driver && $BENCHMARKS_PATH/scripts/aeron/echo-server && kill -9 \$command_pid && wait" \
    "$BENCHMARKS_PATH/scripts/aeron/benchmark.properties" \
    "uk.co.real_logic.benchmarks.remote.outputFileNamePrefix=echo-$scenario" \
    "aeron.threading.mode=SHARED" \
    "aeron.archive.threading.mode=SHARED" \
    "$AERON_DESTINATION_CHANNELS" \
    "$AERON_SOURCE_CHANNELS"
done
